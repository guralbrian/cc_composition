# Cardiac Cell Composition Analysis

Written by [Brian Gural]{https://www.linkedin.com/in/brian-gural-09bb60128/}
Last updated to v0.2.0 on September 5th 2023

## Project Goals

The primary aim of this project is to analyze the cellular composition of cardiac tissue using single-cell RNA sequencing data as a reference. Data is being generated and analyzed by the [Rau Lab at the University of North Carolina at Chapel Hill](https://raulab.web.unc.edu/). We are currently exploring pilot data, consisting of bulk RNAseq from the left ventricles of isoproterenol-treated mice from 16 strains of the Collaborative Cross. For reference-based deconvolution, we are using a combination of internal snRNAseq (LV, untreated, C57B/L6) and publically available scRNAseq (described in the relevant script sub-directory)(https://github.com/guralbrian/cc_composition/tree/main/scripts/load_data/single_cell). 

**This analysis pipeline currently is able to:**

- [Download](https://github.com/guralbrian/cc_composition/tree/main/scripts/load_data/) and [preprocess](https://github.com/guralbrian/cc_composition/tree/main/scripts/quality_control) the raw data
- [Merge sn/scRNAseq references and identify cell-type specific marker genes](https://github.com/guralbrian/cc_composition/blob/main/scripts/analysis/merge_sn_old.Rmd)
- [Perform reference-based deconvolution](https://github.com/guralbrian/cc_composition/blob/main/scripts/analysis/deconvolution_old.Rmd) 
- [Visualize compositions and perform/visualize dimensional reductions](https://github.com/guralbrian/cc_composition/blob/main/scripts/visualization/06222023/composition/comp_and_pca.Rmd)

**Immediate next steps for actual analysis include:**

- Unblind samples 
- Validate compositional estimates with ground truths
    - Ground truth one: Bulk RNAseq of experimentally purified major cell types
    - Ground truth two: Pseudobulk generated by summed expression from sn/scRNAseq
- Estimate phenotype and genotype effects on composition by Dirichlet regression
- Differential expression analysis adjusted w/ compositional covariates

**Further analysis include:**
- QTL mapping for compositional changes during isoproterenol treatment
- Composition-adjusted QTL mapping for heart failure phenotypes
- Further ground-truths after benchwork is completed. Involves *in-vitro* mixtures of RNA isolated from purified cardiac cell types, sequenced by bulk RNAseq *a la* [Tumor Deconvolution DREAM Challenge](https://www.synapse.org/#!Synapse:syn15589870/wiki/592683)

## Expected changes to analysis infrastructure

This project is also meant to be a learning process for reproducible data analysis. Currently, all scripts are .R or .Rmd and meant to be manually opened and run in RStudio. Libraries and languages are not version controlled. Code is being pushed to a working branch and merged to main upon new, personally defined, functional versions. All code, data, and results are stored on UNC's HPC, Longleaf. 

I intend to implement the following:
    1. Snakemake automation for running analysis scripts
        - Will need to adjust .R scripts to accept Snakemake options 
        - .RMD files will need to be converted to .R files 
    2. Choose and implement a package version control system. 
        - Lightweight options include Conda and Renv
        - More robust and intensive options include Docker and Singularity 
            - Docker commands aren't natively supported by Longleaf
            - Singlularity may be able to provide a workaround.
    3. Interactive data visualization tools, like Shiny.
    4. Automated storage of slurm.out files
        - Also would like to merge .out files with R .log files for relevant scripts


## Directory Structure

```
.
├── data
│   ├── raw
│       ├── cc_counts
│       └── rau_sn
│   └── processed
│       ├── single_cell
│       └── bulk
├── scripts
│   └── load_data
│       └── single_cell
│           ├── wu.R
│           ├── martini.R
│           └── tabula_muris.R
├── snakemake
│   └── target_files
├── results
│   └── UNFINISHED
├── tools
│   └── UNFINISHED
├── logs
│   └── slurm
├── cc_composition.Rproj
├── environment.yml
├── Snakefile
└── README.md
```

- `data/raw`: Contains the raw 10x outputs and unprocessed counts matrix for bulk RNAseq (processed by salmon).
- `data/processed/single_cell`: Contains the processed data in h5 format.
- `scripts/load_data/single_cell`: Contains R scripts for data downloading and preprocessing.
- `snakemake/target_files`: Contains Snakemake target files. 
- `logs/slurm`: Contains SLURM log files.

